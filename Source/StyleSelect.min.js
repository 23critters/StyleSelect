/*
---
description: Create styleable Select boxes built on the MooTools Framework

license:
- MIT-style

authors:
- Thomas Kunambi, 23 Critters

requires:
- core/1.3: [Class, Element.Event, Element.Style, Element.Measure]

provides: StyleSelect
...
*/

var StyleSelect=new Class({Implements:[Options],options:{cloneEvents:true,cssClass:"styleme",cssActions:{c:"clicked",d:"disabled",e:"expanded",h:"hover",m:"multiple",o:"optgroup",s:"selected"},inheritCSSClass:true,skipfirst:false},initialize:function(a){try{a.element=document.id(a.element)||a.element;if(a.element===null){throw ("DOM object not found")}}catch(b){if(console){console.log(b)}throw b}if(!a.element.getProperty("multiple")){return new StyleSelect.Simple(a)}else{return new StyleSelect.Multiple(a)}},_setup:function(){var a=this.element.getComputedSize();this.oCss=this.options.cssActions;this.container=new Element("div",{"class":this.options.cssClass,styles:{height:a.height.toInt(),width:a.width.toInt(),padding:Object.values(this.element.getStyles("padding")).toString(),margin:Object.values(this.element.getStyles("margin")).toString()}}).inject(this.element,"after");this.element.setStyle("display","none");this.list=new Element("ul",{"class":"root"}).inject(this.container);this.fnNavigate=this._navigate.bind(this);this.rebuild();if(this.options.inheritCSSClass){this.container.addClass(this.element.get("class"))}document.addEvent("click",function(b){this.list.removeClass(this.oCss.e);this.list.fireEvent("blur",b);document.removeEvent("keydown",this.fnNavigate)}.bind(this))},_fnAlterClass:function(a,c,b){c.removeClass(b);a.addClass(b)},_navigate:function(d){var c=this.container.getElement("li."+this.oCss.h),f=this.container.getElements("li:not(."+this.oCss.o+",."+this.oCss.d+")"),b=null;switch(d.key){case"down":d.preventDefault();if((b=f[f.indexOf(c)+1])&&!b.hasClass(this.oCss.d)){this._fnAlterClass(b,c,this.oCss.h)}break;case"up":d.preventDefault();if((b=f[f.indexOf(c)-1])&&!b.hasClass(this.oCss.d)){this._fnAlterClass(b,c,this.oCss.h)}break;case"space":d.preventDefault();if(c.get("html")&&!c.hasClass(this.oCss.d)){if(d.control){c.addClass(this.oCss.c)}else{this._fnAlterClass(c,f,this.oCss.c)}this._setSelected()}break;case"enter":if(c.get("html")&&!c.hasClass(this.oCss.d)){this._fnAlterClass(c,f,this.oCss.c);this._setSelected();this.list.removeClass(this.oCss.e)}break;case"esc":this.container.getElement("ul").removeClass(this.oCss.e);document.removeEvent("keydown",this.fnNavigate);break;default:if(d.key.length==1){d.preventDefault();for(var a=0;a<f.length;a++){if(d.code==f[a].get("html").charCodeAt(0)){this._fnAlterClass(f[a],f,this.oCss.h);break}}}break}},_setSelected:function(){var a=this.list.getElements("li:not(."+this.oCss.o+")");this.element.getElements("option").set("selected",false);a.each(function(c,b){if(c.hasClass(this.oCss.c)){this.element.getElements("option")[b].set("selected",true);if(this.showSelected){this.showSelected.set("html",c.get("html"));this.showSelected.set("data-value",c.get("data-value"))}}},this)},getSelected:function(){var a=[],b=Object.filter(this.element.getElements("option"),function(c){if(typeof c=="object"){return c.get("selected")}});Object.each(b,function(c){a.include({option:c,value:c.get("value"),text:c.get("text")})});return a},rebuild:function(){this._reset();var a=0;this.element.getElements("option,optgroup").each(function(e){var c=e.get("tag")=="option";if(c){if(!this.options.skipfirst||a>0){if(e.getParent()!==this.o_parent){this.o_parent=e.getParent();this.list=this.list.getParent("ul")}var d=new Element("li",{"class":(e.selected)?this.oCss.s:"",html:e.get("text"),"data-value":e.get("value")}).inject(this.list);if(e.hasAttribute(this.oCss.d)){d.addClass(this.oCss.d)}}a++}else{this.o_parent=e;var b=new Element("li",{"class":e.get("tag"),"data-value":""}).inject(this.list);this.list=new Element("ul",{"class":"ul-"+e.get("tag")}).inject(b);if(e.get("label")){new Element("span",{html:e.get("label"),events:{click:function(f){f.stop()}}}).inject(b,"top")}}},this);this._addCustomEvents();if(this.options.cloneEvents){this.container.cloneEvents(this.element);this.container.removeEvents("change");this.container.getElements("li:not(."+this.oCss.o+",."+this.oCss.d+")").addEvent("click",function(b){this.element.fireEvent("change",b)}.bind(this))}}});StyleSelect.Simple=new Class({Extends:StyleSelect,initialize:function(a){this.setOptions(a);this.element=this.o_parent=this.options.element;this._setup();this.container.addEvent("click",function(f){f.stop();var b=this.list,c=$$("select[style] + div."+this.options.cssClass+" > ul.root");if(b.hasClass(this.oCss.e)){c.removeClass(this.oCss.e);document.removeEvent("keydown",this.fnNavigate)}else{var d=b.getElement("li."+this.oCss.c)||b.getElement("li:first-child");this._fnAlterClass(d,b.getElements("li"),this.oCss.h);this._fnAlterClass(b,c,this.oCss.e);document.addEvent("keydown",this.fnNavigate)}}.bind(this))},_reset:function(){this.list.set("html","");var a=null;if((a=this.list.getNext("a"))){a.dispose()}var b=this.element.getSelected()[0]||new Element("option",{text:"","data-value":""});this.showSelected=new Element("a",{href:"",events:{click:function(c){c.preventDefault()},mousedown:function(c){c.preventDefault()}},html:b.get("text"),"data-value":b.get("data-value")}).inject(this.container)},_addCustomEvents:function(){this.list.addEvent("click",function(b){b.stopPropagation();b.preventDefault();this.list.toggleClass(this.oCss.e)}.bind(this));var a=this.list.getElements("li");a.each(function(b){b.addEvents({mouseover:function(c){if(!c.target.hasClass(this.oCss.d)){this._fnAlterClass(c.target,a,this.oCss.h)}}.bind(this),click:function(c){if(!c.target.hasClass(this.oCss.d)){this._fnAlterClass(c.target,a,this.oCss.c);this._setSelected()}}.bind(this)})},this)}});StyleSelect.Multiple=new Class({Extends:StyleSelect,options:{size:4},initialize:function(a){this.setOptions(a);this.element=this.o_parent=this.options.element;this._setup();this.container.addClass(this.oCss.m);var b=this.options.size||this.element.getProperty("size");this.container.setStyle("height",this.list.getElement("li:first-child").getSize().y*b);this.list.getElements("li").each(function(c){if(c.hasClass(this.oCss.s)){c.addClass(this.oCss.c)}},this)},_reset:function(){this.list.set("html","")},_addCustomEvents:function(){this.list.addEvents({click:function(b){b.stopPropagation()},focus:function(f){var b=this.list,c=$$("select[style] + div."+this.options.cssClass+" > ul.root");c.removeClass(this.oCss.e);var d=b.getElement("li."+this.oCss.c)||b.getElement("li:first-child");this._fnAlterClass(d,b.getElements("li"),this.oCss.h);document.addEvent("keydown",this.fnNavigate)}.bind(this),blur:function(b){this.list.getElements("li").removeClass(this.oCss.h);document.removeEvent("keydown",this.fnNavigate)}.bind(this)});var a=this.list.getElements("li");a.each(function(b){b.addEvents({click:function(c){if(!c.target.hasClass(this.oCss.d)){if(c.control){c.target.addClass(this.oCss.c)}else{this._fnAlterClass(c.target,a,this.oCss.c)}this._setSelected();this.list.fireEvent("focus",c)}}.bind(this)})},this)}});